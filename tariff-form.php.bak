<?php
// {"_META_file_path_": "refor/tariff-form.php"}
// Formulario unificado para crear/editar tarifas

require_once 'includes/config.php';
require_once 'includes/tariff-helpers.php';
require_once 'includes/csv-processor.php';

requireAuth();

// Determinar si es edición o creación
$isEdit = isset($_GET['id']);
$tariff_id = $isEdit ? $_GET['id'] : null;
$pageTitle = $isEdit ? 'Editar Tarifa' : 'Nueva Tarifa';

// Verificar si se ha proporcionado un ID de plantilla
$template_id = isset($_GET['template']) ? intval($_GET['template']) : 1;

// Cargar datos existentes o por defecto
if ($isEdit) {
    $tariff = getTariffById($tariff_id);
    if (!$tariff) {
        redirect('tariffs', ['error' => 'Tarifa no encontrada']);
    }
} else {
    $tariff = getDefaultTariffData($template_id);
}

$errors = [];
$success = false;

// Procesar formulario
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        $data = [
            'tariff_name' => trim($_POST['tariff_name'] ?? ''),
            'company_name' => trim($_POST['company_name'] ?? ''),
            'company_nif' => trim($_POST['company_nif'] ?? ''),
            'company_address' => trim($_POST['company_address'] ?? ''),
            'company_contact' => trim($_POST['company_contact'] ?? ''),
            'logo_url' => trim($_POST['logo_url'] ?? ''),
            'template' => trim($_POST['template'] ?? '41200-00001'),
            'primary_color' => $_POST['primary_color'] ?? '#e8951c',
            'secondary_color' => $_POST['secondary_color'] ?? '#109c61',
            'summary_note' => trim($_POST['summary_note'] ?? ''),
            'conditions_note' => trim($_POST['conditions_note'] ?? ''),
            'legal_note' => trim($_POST['legal_note'] ?? ''),
            'csv_data' => $_POST['csv_data'] ?? ''
        ];
        
        // Validar datos básicos
        if (empty($data['tariff_name'])) {
            $errors[] = 'El nombre de la tarifa es obligatorio';
        }
        
        if (empty($data['company_name'])) {
            $errors[] = 'El nombre de la empresa es obligatorio';
        }
        
        // Procesar archivo CSV si se ha subido
        if (!empty($_FILES['csv_file']['tmp_name'])) {
            $csv_file = $_FILES['csv_file']['tmp_name'];
            $csv_data = file_get_contents($csv_file);
            
            try {
                $json_data = processCSVToJSON($csv_data);
                $data['csv_data'] = $json_data;
            } catch (Exception $e) {
                $errors[] = 'Error al procesar el archivo CSV: ' . $e->getMessage();
            }
        }
        
        // Si no hay errores, guardar tarifa
        if (empty($errors)) {
            $result = saveTariff($data, $tariff_id);
            
            if ($result['success']) {
                $success = true;
                $tariff_id = $result['tariff_id'];
                
                if (!$isEdit) {
                    // Redirigir a la edición si es una nueva tarifa
                    redirect('tariff-form.php', ['id' => $tariff_id, 'success' => 1]);
                }
                
                // Recargar datos de la tarifa
                $tariff = getTariffById($tariff_id);
            } else {
                $errors[] = $result['message'];
            }
        }
    } catch (Exception $e) {
        $errors[] = 'Error: ' . $e->getMessage();
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $pageTitle ?> - Generador de Presupuestos</title>
    <link rel="stylesheet" href="<?= asset('css/main.css') ?>">
    <link rel="stylesheet" href="<?= asset('css/header.css') ?>">
    <link rel="stylesheet" href="<?= asset('css/forms.css') ?>">
    <!-- Aseguramos que se cargue la librería de iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Estilos para el layout de dos columnas */
        .two-column-layout {
            display: flex;
            flex-wrap: nowrap;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .preview-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .form-section, .preview-section {
            background: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .form-section h2, .preview-section h2 {
            color: #109c61;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #f5f5f5;
            padding-bottom: 0.5rem;
        }
        
        .file-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f5f5f5;
            transition: border-color 0.3s;
        }
        
        .file-upload-text {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .header-title__buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        .csv-format {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .csv-example {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #333;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        /* Estilos para botones */
        .btn--primary, .btn--tariffs {
            background: #e8951c;
            color: white;
        }
        
        .btn--secondary, .btn--budgets {
            background: #109c61;
            color: white;
        }
        
        .btn--templates, .btn--info {
            background: #17a2b8;
            color: white;
        }
        
        /* Estilos para formularios */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .color-input {
            height: 40px;
            padding: 0;
            border: none;
        }
        
        /* Estilos para jerarquía de tarifas */
        .hierarchy-container {
            margin-top: 1rem;
        }
        
        .tariff-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Estilos adicionales para espaciado */
        .spacing {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header igual que en otras páginas -->
        <div class="header">
            <div class="header-content">
                <div class="logo">Generador de Presupuestos</div>
                <nav class="main-nav">
                    <a href="dashboard.php" class="nav-item">Dashboard</a>
                    <a href="tariffs.php" class="nav-item active">Tarifas</a>
                    <a href="budgets.php" class="nav-item">Presupuestos</a>
                </nav>
                <div class="user-menu">
                    <a href="logout.php" class="btn-icon btn-icon--black" title="Cerrar Sesión">
                        <i data-lucide="log-out"></i>
                    </a>
                </div>
            </div>
        </div>

        <?php if ($success): ?>
            <div class="alert alert-success">
                Tarifa <?= $isEdit ? 'actualizada' : 'creada' ?> correctamente
            </div>
        <?php endif; ?>

        <?php if (!empty($errors)): ?>
            <div class="alert alert-error">
                <ul>
                    <?php foreach ($errors as $error): ?>
                        <li><?= htmlspecialchars($error) ?></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>

        <!-- Título de página con botones a la derecha -->
        <div class="spacing">
            <div class="page-header">
                <h1><?= $pageTitle ?></h1>
                <div class="header-title__buttons">
                    <a href="tariffs.php" class="btn btn--tariffs">Tarifas</a>
                    <button type="submit" form="tariffForm" class="btn btn--tariffs"><?= $isEdit ? 'Actualizar' : 'Guardar' ?> Tarifa</button>
                    <button type="button" class="btn btn--templates">Plantillas</button>
                    <button type="button" class="btn btn--templates">Guardar como Plantilla</button>
                </div>
            </div>
        </div>

        <!-- Contenido principal en dos columnas -->
        <div class="spacing">
            <div class="two-column-layout">
                <!-- Columna izquierda: Formulario -->
                <div class="form-column" style="flex: 1;">
                    <form id="tariffForm" method="POST" enctype="multipart/form-data">
                        <input type="hidden" id="csv_data" name="csv_data" value="<?= htmlspecialchars($tariff['json_tariff_data'] ?? '') ?>">
                        
                        <!-- Card 1: Información de la Tarifa -->
                        <div class="form-section">
                            <h2>Información de la Tarifa</h2>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre de la Tarifa</label>
                                <input type="text" class="form-input" name="tariff_name" placeholder="Introduce el nombre" value="<?= htmlspecialchars($tariff['title'] ?? '') ?>" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripción de la Tarifa</label>
                                <textarea class="form-textarea" name="description" rows="3" placeholder="Descripción de la tarifa"><?= htmlspecialchars($tariff['description'] ?? '') ?></textarea>
                            </div>
                        </div>

                        <!-- Card 2: Datos de la Empresa -->
                        <div class="form-section">
                            <h2>Datos de la Empresa</h2>
                            
                            <div class="form-group">
                                <label class="form-label">Logo</label>
                                <div class="file-upload-area">
                                    <div class="file-upload-text">Arrastra aquí o selecciona tu imagen</div>
                                    <button type="button" class="btn btn--primary">Seleccionar</button>
                                    <input type="hidden" name="logo_url" value="<?= htmlspecialchars($tariff['logo_url'] ?? '') ?>">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nombre de la Empresa</label>
                                <input type="text" class="form-input" name="company_name" placeholder="Nombre de la empresa" value="<?= htmlspecialchars($tariff['name'] ?? '') ?>" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">NIF/CIF</label>
                                <input type="text" class="form-input" name="company_nif" placeholder="NIF/CIF" value="<?= htmlspecialchars($tariff['nif'] ?? '') ?>">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Dirección</label>
                                <input type="text" class="form-input" name="company_address" placeholder="Dirección" value="<?= htmlspecialchars($tariff['address'] ?? '') ?>">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Contacto</label>
                                <input type="text" class="form-input" name="company_contact" placeholder="Contacto" value="<?= htmlspecialchars($tariff['contact'] ?? '') ?>">
                            </div>
                        </div>

                        <!-- Card 3: Configuración del PDF -->
                        <div class="form-section">
                            <h2>Configuración del PDF</h2>
                            
                            <div class="form-group">
                                <label class="form-label">Días de validez</label>
                                <input type="number" class="form-input" name="validity" placeholder="30" value="<?= htmlspecialchars($tariff['validity'] ?? '30') ?>">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Plantilla PDF</label>
                                <select class="form-select" name="template">
                                    <option value="41200-00001" <?= ($tariff['template'] ?? '') == '41200-00001' ? 'selected' : '' ?>>Plantilla Básica</option>
                                    <option value="41200-00002" <?= ($tariff['template'] ?? '') == '41200-00002' ? 'selected' : '' ?>>Plantilla Premium</option>
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Color Primario</label>
                                    <input type="color" class="form-input color-input" name="primary_color" value="<?= $tariff['primary_color'] ?? '#109c61' ?>">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Color Secundario</label>
                                    <input type="color" class="form-input color-input" name="secondary_color" value="<?= $tariff['secondary_color'] ?? '#e8951c' ?>">
                                </div>
                            </div>
                        </div>

                        <!-- Card 4: Textos Legales del PDF -->
                        <div class="form-section">
                            <h2>Textos Legales del PDF</h2>
                            
                            <div class="form-group">
                                <label class="form-label">Nota del Resumen</label>
                                <textarea class="form-textarea" name="summary_note" rows="3" placeholder="Nota del resumen"><?= htmlspecialchars($tariff['summary_note'] ?? '') ?></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nota de Condiciones</label>
                                <textarea class="form-textarea" name="conditions_note" rows="3" placeholder="Nota de condiciones"><?= htmlspecialchars($tariff['conditions_note'] ?? '') ?></textarea>
                            </div>
                        </div>

                        <!-- Card 5: Condiciones Legales del Formulario -->
                        <div class="form-section">
                            <h2>Condiciones Legales del Formulario</h2>
                            
                            <div class="form-group">
                                <label class="form-label">Nota Legal del Formulario</label>
                                <textarea class="form-textarea" name="legal_note" rows="4" placeholder="Nota legal del formulario"><?= htmlspecialchars($tariff['legal_note'] ?? '') ?></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Columna derecha: Carga de datos -->
                <div class="preview-column" style="flex: 1;">
                    <!-- Card 1: Selector de Tarifa -->
                    <div class="preview-section">
                        <h2>Selección de Tarifa</h2>
                        
                        <div class="form-group">
                            <div class="file-upload-area">
                                <div class="file-upload-text">Arrastra aquí o selecciona tu archivo CSV</div>
                                <input type="file" id="csv_file" name="csv_file" accept=".csv" style="display: none;">
                                <button type="button" class="btn btn--primary" onclick="document.getElementById('csv_file').click()">Seleccionar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: Formato requerido -->
                    <div class="preview-section">
                        <h2>Formato requerido</h2>
                        
                        <div class="csv-format">
                            <pre class="csv-example">"Nivel","ID","Nombre","Descripción","Ud","%IVA","PVP"
"Capítulo",1,"Nombre del Capítulo 1",,,,
"Subcapítulo","1.1","Nombre del Subcapítulo 1.1",,,,
"Apartado","1.1.1","Nombre del Apartado 1.1.1",,,,
"Partida","1.1.1.1","Nombre del Partida 1.1.1.1","Descripción de la Partida 1.1.1.1","Unidad","5,00","125,00"
"Capítulo",2,"Nombre del Capítulo 2",,,,
"Subcapítulo","2.1","Nombre del Subcapítulo 2.1",,,,
"Partida","2.1.1","Nombre del Partida 2.1.1","Descripción de la Partida 2.1.1","hora","10,00","20,00"
"Capítulo",3,"Nombre del Capítulo 3",,,,
"Partida","3.1","Nombre del Partida 3.1","Descripción de la Partida 3.1","m","21,00","5,00"</pre>
                        </div>
                    </div>

                    <div id="tariffSection" <?= empty($tariff['json_tariff_data']) ? 'style="display: none;"' : '' ?>>
                        <div class="preview-section">
                            <h2>Tarifa Actual</h2>
                            <div class="tariff-actions">
                                <button type="button" id="exportCsv" class="btn btn--secondary">Exportar</button>
                                <button type="button" id="showJson" class="btn btn--info">JSON</button>
                                <button type="button" id="deleteTariff" class="btn btn--danger">Borrar</button>
                            </div>
                            <div id="hierarchyOutput" class="hierarchy-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="<?= asset('js/tariff-form.js') ?>"></script>
    <script>
        // Inicializar los iconos de Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Inicializar el manejador del formulario
        document.addEventListener('DOMContentLoaded', function() {
            new TariffFormHandler();
        });
    </script>
</body>
</html>